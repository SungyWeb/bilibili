<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <script>
    function slep (delay) {
      // js引擎会一直卡在这里 直到循环结束
      for(let cur = Date.now(); Date.now() - cur < delay;) {}
    }
    const works = [
      () => {
        console.log('work1 start')
        slep(20)    // 因为这个任务的执行超过了16.6ms，即一贞的时候，所以浏览器会放弃执行
        console.log('work1 end')
      },
      () => {
        console.log('work2 start')
        slep(20)
        console.log('work2 end')
      },
      () => {
        console.log('work3 start')
        slep(20)
        console.log('work3 end')
      },
    ]
    function runFirstWork() {
      // 每次将第一个取出 并执行
      works.shift()()
    }
    // 循环递归调用
    function workLoop (deadline) {
      console.log('本贞剩余可用时间' + deadline.timeRemaining())
      // deadline.timeRemaining()  返回当前贞还剩下多少时间可以分配
      // deadline.didTimeout 表示此callback是否超时
      while((deadline.timeRemaining() > 0 || deadline.didTimeout) && works.length > 0) {
        // 如果当前贞剩余时间大于0 或者 已经超时
        runFirstWork()
      }
      // 跳出循环 说明当前贞没有剩余时间了，就需要放弃执行任务的控制权， 将控制权交还给浏览器
      console.log('没有剩余时间来')
      // 如果还有剩余任务，在此调用， 告诉浏览器空余时，来执行任务
      if(works.length) window.requestIdleCallback(workLoop, {timeout: 1000})
    }
    window.requestIdleCallback(workLoop, {timeout: 1000})
  </script>
</body>
</html>